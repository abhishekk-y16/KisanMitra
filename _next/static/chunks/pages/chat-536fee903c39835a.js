(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[180],{22:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/chat",function(){return a(762)}])},762:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return c}});var n=a(5893),i=a(7294),r=a(1163),s=a(7342);function c(){let e=e=>{if(!e)return"";if(e.crop&&!e.diagnosis)return"Crop: ".concat(e.crop," (").concat(Math.round(100*(e.confidence||0)),"% confidence)");if(e.diagnosis||e.symptoms||e.treatment){let t=[];if(e.crop&&t.push("Crop: ".concat(e.crop," (").concat(Math.round(100*(e.confidence||0)),"% confidence)")),e.diagnosis&&t.push("Diagnosis: ".concat(e.diagnosis)),e.symptoms&&e.symptoms.length&&t.push("Symptoms: ".concat(e.symptoms.join(", "))),e.treatment){let a=e.treatment;a.immediateActions&&a.immediateActions.length&&t.push("Immediate: ".concat(a.immediateActions.join("; "))),a.organicRemedies&&a.organicRemedies.length&&t.push("Organic: ".concat(a.organicRemedies.join("; "))),a.futurePrevention&&a.futurePrevention.length&&t.push("Prevention: ".concat(a.futurePrevention.join("; ")))}return e.warnings&&e.warnings.length&&t.push("Warnings: ".concat(e.warnings.join("; "))),t.filter(Boolean).join("\n\n")}if(e.reply)return e.reply;try{return JSON.stringify(e,null,2)}catch(t){return String(e)}},[t,a]=(0,i.useState)([]),[c,o]=(0,i.useState)(""),[l,h]=(0,i.useState)(null),[m,d]=(0,i.useState)(null),[p,u]=(0,i.useState)(!1),f=(0,i.useRef)(null),g=(0,r.useRouter)();(0,i.useEffect)(()=>{try{let t=sessionStorage.getItem("chat_prefill");if(t){let n=JSON.parse(t);if(n.imageUrl||n.imageBase64){h(n.imageUrl||n.imageBase64||null);let t=(n.transcript?n.transcript+"\n\n":"")+"Please analyze the attached image and provide diagnosis and recommended treatment steps.";(async()=>{try{var i;let r={message:t,language:"en"};n.imageUrl?r.image_url=n.imageUrl:n.imageBase64&&(r.image_base64=null!==(i=n.imageBase64.split(",")[1])&&void 0!==i?i:n.imageBase64);let s="http://127.0.0.1:8000",c=await fetch("".concat(s,"/api/vision_chat"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}),o=await c.text().catch(()=>"");if(c.ok)try{let t=JSON.parse(o||"{}"),n=t&&(t.diagnosis||t.crop||t.reply)?e(t):t.reply||o||"No reply";a(e=>[...e,{from:"bot",text:n}])}catch(e){a(e=>[...e,{from:"bot",text:o||"No reply"}])}else{404===c.status&&d("Vision service not available — using text-only fallback.");let e="Image: ".concat(n.imageUrl?n.imageUrl:"[attached image]","\n\n").concat(t),i=await fetch("".concat(s,"/api/chat"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e})});if(!i.ok)throw Error("fallback chat failed");let r=await i.json();a(e=>[...e,{from:"bot",text:r.reply}])}}catch(e){d("Chat service currently unavailable."),a(e=>[...e,{from:"bot",text:"Chat service currently unavailable."}])}finally{try{sessionStorage.removeItem("chat_prefill")}catch(e){}}})()}}}catch(e){}let t=window.SpeechRecognition||window.webkitSpeechRecognition;if(t){let e=new t;e.lang="en-IN",e.interimResults=!1,e.maxAlternatives=1,e.onresult=e=>{let t=e.results[0][0].transcript;o(e=>e?e+" "+t:t)},e.onend=()=>u(!1),f.current=e}},[]);let y=()=>{if(f.current)try{f.current.start(),u(!0)}catch(e){console.debug(e)}},x=()=>{if(f.current)try{f.current.stop()}catch(e){}u(!1)},b=async t=>{let n=(null!=t?t:c).trim();if(n){a(e=>[...e,{from:"user",text:n}]),o("");try{let t="http://127.0.0.1:8000";if(l&&/\b(name|which|identify|what)\b/i.test(n)&&/\b(crop|plant|this)\b/i.test(n)){let i={message:n,language:"en"};(null==l?void 0:l.startsWith("data:"))?i.image_base64=l.split(",")[1]:l&&(i.image_url=l);let r=await fetch("".concat(t,"/api/vision_chat"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}),s=await r.text().catch(()=>"");if(!r.ok){404===r.status&&d("Vision service not available — falling back to text-only chat.");let e="".concat(i.message)+(i.image_url?"\n\nImage: ".concat(i.image_url):"");try{let n=await fetch("".concat(t,"/api/chat"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e})});if(!n.ok)throw Error("fallback failed");let i=await n.json();a(e=>[...e,{from:"bot",text:i.reply}]);return}catch(e){throw Error("vision chat failed and fallback failed")}}try{let t=JSON.parse(s||"{}"),n=t&&(t.diagnosis||t.crop||t.reply)?e(t):t.reply||s||"No reply";a(e=>[...e,{from:"bot",text:n}])}catch(e){a(e=>[...e,{from:"bot",text:s||"No reply"}])}}else{let e=await fetch("".concat(t,"/api/chat"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:n})});if(!e.ok)throw Error("chat failed");let i=await e.json();a(e=>[...e,{from:"bot",text:i.reply}])}}catch(e){d("Chat service unavailable."),a(e=>[...e,{from:"bot",text:"Sorry, chat service unavailable."}])}}};return(0,n.jsx)("div",{className:"min-h-screen bg-neutral-50 py-8",children:(0,n.jsxs)("div",{className:"max-w-3xl mx-auto px-4",children:[(0,n.jsxs)("div",{className:"flex items-center justify-between mb-6",children:[(0,n.jsx)("h1",{className:"text-2xl font-bold",children:"Crop Health Chat"}),(0,n.jsx)("div",{className:"flex gap-2",children:(0,n.jsx)(s.zx,{variant:"ghost",onClick:()=>g.push("/"),children:"Back"})})]}),(0,n.jsx)(s.Zb,{className:"p-4 mb-4",children:(0,n.jsxs)("div",{className:"space-y-4",children:[l&&(0,n.jsxs)("div",{className:"mt-2",children:[(0,n.jsx)("div",{className:"text-xs text-neutral-500 mb-1",children:"Attached image from Diagnostic:"}),(0,n.jsx)("img",{src:l,alt:"prefill",className:"w-48 h-48 object-cover rounded-lg border"})]}),(0,n.jsxs)("div",{className:"flex gap-2",children:[(0,n.jsx)(s.zx,{onClick:()=>p?x():y(),children:p?"Stop":"Speak"}),(0,n.jsx)(s.zx,{onClick:()=>{o("")},children:"Clear"})]})]})}),(0,n.jsx)("div",{className:"space-y-3 mb-6",children:t.map((e,t)=>(0,n.jsx)("div",{className:"user"===e.from?"text-right":"text-left",children:(0,n.jsx)("div",{className:"inline-block px-4 py-2 rounded-lg ".concat("user"===e.from?"bg-primary-600 text-white":"bg-white border"),children:e.text})},t))}),(0,n.jsxs)("div",{className:"flex gap-2",children:[(0,n.jsx)(s.II,{value:c,onChange:e=>o(e.target.value),placeholder:"Type your question"}),(0,n.jsx)(s.zx,{onClick:()=>b(),disabled:!c,children:"Send"})]})]})})}}},function(e){e.O(0,[342,888,774,179],function(){return e(e.s=22)}),_N_E=e.O()}]);